#!/bin/bash

# fzf default options defined in .zprofile
clear

case $1 in
    "bin")
        sel=$(fzf --prompt="$1 > " <<< $(rg --ignore-file $XDG_CONFIG_HOME/ag/agignore --hidden --no-messages --files /usr/bin $HOME/local/bin $PRIVATE/bin))
        for file in ${sel[@]}
        do
            i3-msg exec $file
        done
        ;;
    "diff")
        sel=$(fzf --prompt="$1 > " <<< $(rg --ignore-file $XDG_CONFIG_HOME/ag/agignore --hidden --no-messages --files /etc $HOME $PRIVATE))
        if [[ -n $sel ]]; then
            i3-msg exec "alacritty --title=dispatch -e /usr/bin/nvim -dR $(echo ${sel[@]})"
        fi
        ;;
    "file")
        sel=$(fzf --prompt="$1 > " <<< $(rg --ignore-file $XDG_CONFIG_HOME/ag/agignore --hidden --no-messages --files /etc $HOME $PRIVATE))
        for file in ${sel[@]}
        do
            ftype=$(file $file --mime-type | awk '{print $file}')

            case $ftype in
                *"image"*)
                    feh $file > /dev/null
                    ;;
                *"text"* | *"empty"* | *"javascript"*)
                    python -c "from neovim import attach; nvim=attach('socket', path='$XDG_RUNTIME_DIR/nvim'); nvim.command('bad $file');"
                    ;;
                *"pdf"*)
                    zathura --fork $file
                    ;;
                *"video"*)
                    mplayer $file > /dev/null
                    ;;
                *"symlink"*)
                    target=$(readlink $file)
                    launch $1 $target
                    ;;
            esac
        done
        ;;
    "man")
        sleep 0.5
        sel=$(fzf --prompt="$1 > " <<< $(/usr/bin/man -k "" | awk '{print $1,$2}'))
        for man in ${sel[@]}
        do
            python -c "from neovim import attach; nvim=attach('socket', path='$XDG_RUNTIME_DIR/nvim'); nvim.command('Man $man');"
        done
        ;;
    "kill")
        sel=$(fzf --prompt="$1 > " <<< $(ps -eo "%p : %U %c %a" | tail -n +2))
        for proc in ${sel[@]}
        do
            if [ "x$proc" != "x" ]
            then
                kill -9 $proc
            fi
        done
        ;;
    "ssh")
        sel=$(fzf --prompt="$1 > " <<< $(cat $PRIVATE/ssh/ssh_config | grep -oP '(?<=Host\ ).*?$'))
        for loc in ${sel[@]}
        do
            #tmux new-window -n "ssh-$loc" -t "scratchbottom" "$LOCALDIR/bin/ssh $loc"
            i3-msg exec "alacritty --title=dispatch -e $LOCALDIR/bin/ssh $loc"
        done
        ;;
    "pwd")
        if [ ! -f $XDG_DATA_HOME/npm/bin/bw ]; then
            npm install -g @bitwarden/cli
        fi
        if [ "$($XDG_DATA_HOME/npm/bin/bw login --check)" == "You are not logged in." ]; then
            $XDG_DATA_HOME/npm/bin/bw login --raw > $XDG_RUNTIME_DIR/bitwarden
        fi
        #if [[ ! -f $XDG_RUNTIME_DIR/bitwarden || "$($XDG_DATA_HOME/npm/bin/bw list items --session=$(cat $XDG_RUNTIME_DIR/bitwarden))" == "Vault is locked." ]]; then
        if [ ! -f $XDG_RUNTIME_DIR/bitwarden ]; then
            $XDG_DATA_HOME/npm/bin/bw unlock --raw > $XDG_RUNTIME_DIR/bitwarden
        fi
        session=$(cat $XDG_RUNTIME_DIR/bitwarden)
        sel=$(fzf -1 --prompt="$1 > " <<< $($XDG_DATA_HOME/npm/bin/bw list items --session=$session | jq '.[].name') | sed -e s/\"//g)
        p=$($XDG_DATA_HOME/npm/bin/bw get password $sel --session=$session)
        if [ ! -z "${QUTE_FIFO+x}" ]; then
            # called by qutebrowser
            u=$($XDG_DATA_HOME/npm/bin/bw get username $sel --session=$session)
            echo "insert-text $u ;; later 50 fake-key <Tab> ;; later 50 insert-text $p ;; enter-mode insert" >> "$QUTE_FIFO"
            exit
        else
            # copy pass to clipboard
            echo $p | xsel -b -i -z
        fi
        ;;
esac
