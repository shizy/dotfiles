#!/bin/bash

# Only supports up to 3 monitors!

source $XDG_CONFIG_HOME/zsh/.zprofile

declare -A monitor

layouts=(${MONITOR_LAYOUTS//:/ })
lid_state=$(cat /proc/acpi/button/lid/LID*/state | grep -oP '\s\K\w+')
output=$(xrandr)
screen_name=($(grep -oP '.*?(?=\ (dis)?connected)' <<< "$output"))
connections=($(grep -oP '(dis)?connected' <<< "$output"))
conns=$(grep -o '[^dis]connected' <<< "${connections[@]}" | wc -l)
desktops=(5 6 7 8 9 0)

# set primary monitor
if [[ "$lid_state" == "closed" ]] && [ $conns -gt 1 ]; then
    first=($(grep -oP '(dis)?connected' <<< "${connections[@]:1}" | grep -nP '^connected$' | cut -c 1))
    primary=${screen_name[${first[0]}]}
else
    primary=${screen_name[0]}
fi

# set default desktops for the primary monitor
xrandr --output $primary --auto
bspc monitor $primary -d 1 2 3 4

connected=1
for ((i=1; i < ${#screen_name[@]}; i++))
do
    if [[ "${connections[$i]}" == "connected" ]]; then
        if [[ "${screen_name[$i]}" != "$primary" ]]; then
            xrandr --output ${screen_name[$i]} ${layouts[$((connected-1))]} $primary --auto
            echo "xrandr --output ${screen_name[$i]} ${layouts[$((connected-1))]} $primary --auto"
            bspc monitor ${screen_name[$i]} -d ${desktops[@]:$(((connected-1)*3)):${#desktops[@]}}
            echo "bspc monitor ${screen_name[$i]} -d ${desktops[@]:$(((connected-1)*3)):${#desktops[@]}}"
            ((connected++))
        fi
    else
        xrandr --output ${screen_name[$i]} --off
        echo "xrandr --output ${screen_name[$i]} --off"
    fi
done

[[ $con -eq 1 ]] &&
    bspc monitor $primary -d 1 2 3 4 ${desktops[@]}

sleep 2
systemctl --user restart panel
