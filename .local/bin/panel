#!/bin/bash

if [ $(pgrep -c panel) -gt 1 ]; then
    exit
fi

icons=(" " " " " " " " " " " " " " " " " " " ")
monitors=$(bspc query -M | wc -l)
urg='${color '$COLOR_URGENT'}'
cur='${color '$COLOR_NOTIFY'}'
occ='${color #383838}'
res='${color}'

[ ! -e $XDG_RUNTIME_DIR/desktop_status.fifo ] &&
    mkfifo $XDG_RUNTIME_DIR/desktop_status.fifo

sleep 3
conky -c $XDG_CONFIG_HOME/conky/desktop_status.conf &
conky -c $XDG_CONFIG_HOME/conky/pc_status.conf &

bspc subscribe | while read -r line; do

    desktops=($(grep -oP '(?<=\:)..(?=\:)' <<< "$line"))
    desktop_status=""
    dtop=1
    cur_desktop=$(bspc query -D -d)

    for desktop in ${desktops[@]}
    do

        [ $dtop -eq $cur_desktop ] && [ $monitors -gt 1 ] &&
            icon="${icons[$(($dtop - 1))]}" ||
            icon=" ${icons[$(($dtop -1 ))]} "

        case $desktop in
            "o"*) desktop_status+=" $occ$icon$res ";;
            "O"*|"F"*) desktop_status+=" $cur$icon$res ";;
            "u"*|"U"*)
                desktop_status+=" $urg$icon$res "
                xdotool search --class conky_desktop_status windowmove x 0
                ;;
            "L"*)
                [ $monitors -gt 1 ] &&
                    desktop_status+="\t"
                    dtop=$(($dtop - 1))
        esac

        dtop=$(($dtop + 1))
    done
    echo -e "$desktop_status" > $XDG_RUNTIME_DIR/desktop_status.fifo
done
