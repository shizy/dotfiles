#!/bin/bash


# ag file search
stack+=$(ag -p $XDG_CONFIG_HOME/ag/agignore -fli --hidden -g "" ~ /etc 2>/dev/null | sed -e 's/^/file:\t/')
# man page search
stack+=$(/usr/bin/man -k "" | awk '{print $1,$2}' | sed -e 's/^/man:\t/')
# pacman listing
stack+=$(pacman -Sl | awk '{print $1,$2,$4}' | sed -e 's/^/pkg:\t/' -e 's/\ /\ \/ \ /g')
stack+=$(pacman -Qqm | sed -e 's/^/pkg:\t\ aur\ \/\ /' -e 's/$/\ \/\ \[installed\]/')
# process search
stack+=$(ps -eo "%p : %U %c %a" | sed -e 's/^/proc:\t/')


# will probably choke on a file / folder with a space in it!
selection=$(fzf -m --select-1 --exit-0 <<< "$stack" --bind "alt-j:down,alt-k:up,alt-h:backward-char,alt-l:forward-char,alt-v:toggle" | sed -e 's/[\t|\ |)]//g' -e 's/(/:/g')
selection=(${selection//\r\n/ })

launch () {
    hide=true
    targets=(${2//;/ })

    case $1 in
        "file")
            for file in ${targets[@]}
            do
                ftype=$(file $file --mime-type | awk '{print $file}')

                case $ftype in
                    *"image"*)
                        i3-msg exec feh $file > /dev/null
                        ;;
                    *"text"* | *"empty"* | *"javascript"*)
                        nvim "hide e $file"
                        ;;
                    *"pdf"*)
                        zathura --fork $file
                        ;;
                    *"video"*)
                        i3-msg exec mplayer $file > /dev/null
                        ;;
                    *"symlink"*)
                        target=$(readlink $file)
                        launch $1 $target
                        ;;
                esac
            done
            ;;
        "man")
            for man in ${targets[@]}
            do
                nvim "Man $man"
            done
            ;;
        "proc")
            for proc in ${targets[@]}
            do
                if [ "x$proc" != "x" ]
                then
                    kill $proc
                fi
            done
            ;;
        "pkg")
            toremove=($(grep -oP '([^|;|\/]*?)+.(?=\/\[installed\];)' <<< $2))
            toinstall=($(grep -oP '\/([^|\/|;]+)\/(?!\[installed\])' <<< $2 | sed -e 's/\///g'))
            hide=false
            if [[ ${#toremove[@]} -gt 0 ]]; then
                sudo pacman -Rns ${toremove[@]}
            fi
            if [[ ${#toinstall[@]} -gt 0 ]]; then
                sudo pacman -S ${toinstall[@]}
            fi
            ;;
    esac
}

if [ $hide ]; then
    i3-msg '[class="Termite" title="search"] scratchpad show'
fi

declare -A collection
for sel in "${selection[@]}"
do
    sel=(${sel//:/ })
    #launch ${sel[0]} ${sel[1]}
    collection[${sel[0]}]+="${sel[1]};"
done

for class in ${!collection[@]}
do
    launch $class ${collection[$class]}
done

i3-msg '[class="Termite" title="search"] kill'
