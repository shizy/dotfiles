#!/bin/bash

if [ $(pidof | pgrep fzf) ]; then
    i3-msg '[class="Termite" title="search"] kill'
    exit
fi

# ag file search
stack+=$(ag -p $XDG_CONFIG_HOME/ag/agignore -fli --hidden -g "" ~ /etc 2>/dev/null | sed -e 's/^/file:\t/')
# man page search
stack+=$(/usr/bin/man -k "" | awk '{print $1,$2}' | sed -e 's/^/man:\t/')
# pacman listing
stack+=$(pacman -Sl | sed -e 's/^/pkg:\t/' -e 's/\ /\ \/ \ /g')
# process search
stack+=$(ps -eo "%p : %U %c %a" | sed -e 's/^/proc:\t/')

#TODO:
#alt-o:execute(fuzzylaunch {})?

# will probably choke on a file / folder with a space in it!
selection=$(fzf -m --select-1 --exit-0 <<< "$stack" --bind "alt-j:down,alt-k:up,alt-h:backward-char,alt-l:forward-char,alt-v:toggle" | sed -e 's/[\t|\ |)]//g' -e 's/(/:/g')
selection=(${selection//\r\n/ })

launch () {
    hide=true

    case $1 in
        "file")
            ftype=$(file $2 --mime-type | awk '{print $2}')

            case $ftype in
                *"image"*)
                    i3-msg exec feh $2 > /dev/null
                    ;;
                *"text"* | *"empty"* | *"javascript"*)
                    nvim "hide e $2"
                    ;;
                *"pdf"*)
                    zathura --fork $2
                    ;;
                *"video"*)
                    i3-msg exec mplayer $2 > /dev/null
                    ;;
                *"symlink"*)
                    target=$(readlink $2)
                    launch $1 $target
                    ;;
            esac
            ;;
        "man")
            nvim "Man $2"
            ;;
        "proc")
            echo $2
            if [ "x$2" != "x" ]
            then
                kill $2
            fi
            ;;
        "pkg")
            pkg=(${2//\// })
            hide=false
            if [ "${pkg[3]}" == "[installed]" ]; then
                sudo pacman -Rns ${pkg[1]}
            else
                sudo pacman -S ${pkg[1]}
            fi
            ;;
    esac
}

if [ $hide ]; then
    i3-msg '[class="Termite" title="search"] scratchpad show'
fi

for sel in "${selection[@]}"
do
    sel=(${sel//:/ })
    target=${sel[1]}
    launch ${sel[0]} $target
done

i3-msg '[class="Termite" title="search"] kill'
