#!/bin/bash

if [ $(pgrep -c jeeves) -gt 1 ]; then
    exit
fi

#TODO:
# get font height to calculate rows
# move to screen coords


icons=("" "" "" "IV" "V" "VI" "VII" "VIII" "" "")
urg=$(tput setaf 200)
occ=$(tput setaf 203)
cur=$(tput setaf 202)
res=$(tput sgr0)
bold=$(tput bold)
bkg=$(tput setab 203)
cols=$(tput cols)
horiz=$(for i in $(seq 1 $cols); do printf "%.0s"; done; echo "")
last_urgent=""

update () {

    urgent=""
    [ $1 ] &&
        wm_status=$1 ||
        wm_status=$(bspc control --get-status)

    timedate="$bold"$(figlet -ct $(date "+%I : %M %P"))"\n"
    timedate+="  $(date '+%a, %b %d %Y')$res"

    power=$(cat /sys/class/power_supply/BAT0/capacity)
    power_status="$(cat /sys/class/power_supply/BAT0/status)"
    [ $power -le 19 ] && urgent+="P"
    [ $power -ge 0 ]  && power_icon="$urg$res"
    [ $power -ge 20 ] && power_icon=""
    [ $power -ge 40 ] && power_icon=""
    [ $power -ge 60 ] && power_icon=""
    [ $power -ge 80 ] && power_icon=""
    [ "$power_status" == "Charging" ] && power_icon="$cur$res"

    vol=$(amixer get -M Master)
    [ "$(grep 'off' <<< $vol)" != "" ] &&
        vol_level="\t(Mute)" ||
        vol_level="\t($(amixer get -M Master | grep -oP '(?<=\[).*?(?=\%\])')%)"

    eth=$(connmanctl services | grep -oP '(?<=A.\ ).*?(?=\ *?ethernet)')
    [ "$eth" == "Wired" ] &&
        eth_speed="\t($eth)" ||
        eth_speed=""

    wifi=$(connmanctl services | grep -oP '(?<=A.\ ).*?(?=\ *?wifi)')
    [ "$wifi" != "" ] &&
        wifi_ssid="\t($wifi)" ||
        wifi_ssid=""

    vpn=""
    unlocked=""

    desktops=($(sed -e 's/:/\ /g' <<< "$wm_status"))
    len=$((${#desktops[@]}-2))
    desktop_status=""
    prev_desktop=$(bspc query -D -d prev)
    for desktop in ${desktops[@]:1:$len}
    do
        stat=${desktop:0:1}
        dtop=${desktop:1:1}-1

        case $stat in
            o) desktop_status+="  ${occ}${icons[$dtop]}${res}  ";;
            O) desktop_status+="  ${cur}${icons[$dtop]}${res}  ";;
            u)
                desktop_status+="  ${urg}${icons[$dtop]}${res}  "
                urgent+=$dtop
                ;;
        esac
    done

    if [ "$urgent" != "$last_urgent" ] && [ "$urgent" != "" ]; then
        scratchpad jeeves show
    fi
    last_urgent=$urgent
    urgent=""

    # output
    output="$desktop_status\n"
    output+="$horiz\n"
    output+="$timedate\n\n"
    output+="$horiz\n"
    output+="  $power_icon\t($power%)\n"
    output+="  $vol_level\n"
    [ "$wifi" != "" ] && output+="  $wifi_ssid\n"
    [ "$eth" == "Wired" ] && output+="  $eth_speed\n"
    [ -e /tmp/vpn ] && output+="  $vpn\n"
    [ -e /tmp/xautolock-disable ] && output+="  $unlocked\n"

    rows=$(($(grep -o '\n' <<< "$output" | wc -l) + 10))
    clear
    echo -en "$(sed -e 's/\\n$//g' <<< "$output")"
    xdotool search --name jeeves windowsize 400 $(($rows * 15))
}

tput civis
bspc control --subscribe | while read -r line; do update $line; done &
while :; do
    [ "$(xdotool search --onlyvisible --name jeeves)" ] && update;
    sleep 5;
done
wait
