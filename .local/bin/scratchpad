#!/bin/bash

show () {
    xdotool search --name $1 windowmap
}

hide () {
    xdotool search --onlyvisible --name $1 windowunmap
}

create () {

    config=$XDG_CONFIG_HOME/termite/config
    #res=$(bspc query -T -m | head -n 1 | awk '{print $2}')
    w_width=$(bspc query -T -m | grep -oP '(?<="width":).*?(?=,|})' | head -n 1)
    w_height=$(bspc query -T -m | grep -oP '(?<="height":).*?(?=,|})' | head -n 1)
    w_x=$(bspc query -T -m | grep -oP '(?<="x":).*?(?=,|})' | head -n 1)
    w_y=$(bspc query -T -m | grep -oP '(?<="y":).*?(?=,|})' | head -n 1)
    res=($w_width $w_height $w_x $w_y)
    #res=(${res//[x|\+]/ })
    #w_top=$((1 + ${res[3]}))
    w_top=$((${res[3]} - 1))
    w_left=${res[2]}

    if [ $2 ]; then
        cmd="-e $2 &"
    else
        cmd=''
    fi

    case $1 in
        "scratchtop")
            x=$w_left
            y=$w_top
            h=$((${res[1]} / 2))
            w=${res[0]}
            ;;
        "scratchbottom" | "scratchsearch")
            x=$w_left
            y=$(((${res[1]} / 2) + $w_top))
            h=$((${res[1]} / 2))
            if [ $1 == "scratchsearch" ]; then
                y=$((${res[1]} - (${res[1]} / 3) + $w_top))
                h=$((${res[1]} / 3))
            fi
            w=${res[0]}
            ;;
        "scratchleft")
            x=$w_left
            y=$w_top
            h=${res[1]}
            w=$((${res[0]} / 2))
            ;;
        "scratchright")
            x=$((${res[0]} / 2))
            y=$w_top
            h=${res[1]}
            w=$((${res[0]} / 2))
            ;;
    esac

    termite -c $config --geometry ${w}x${h} --title=$1 $cmd &
    until [ $(xdotool search --name $1) ]; do :
    done
    xdotool search --name $1 windowmove $x $y
}

case $2 in
    "show") show $1 || create $1 $3;;
    "hide") hide $1;;
    *) hide $1 || show $1 || create $1 $2;;
esac

bspc node $(printf "0x%x\n" $(xdotool search --name $1) | head -n 1) -d focused -f
